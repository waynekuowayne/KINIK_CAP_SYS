# 拍照機台程式 - 完整使用說明

## 🎯 這個專案已經完成什麼？

✅ **完整的程式框架**
- Form 載入/關閉處理
- 機台設定讀取（從 Registry）
- 拍攝流程管理
- 進度追蹤和顯示
- 錯誤處理機制
- Log 記錄功能

✅ **Registry 整合（已完成）**
- 使用 `RegistryHelper` 自動同步進度
- 無需手動處理資料庫連線
- 所有機台使用同一個 exe

✅ **完善的註解和範例**
- 清楚標示哪裡放您的程式碼
- 提供多種拍照流程範例
- 包含錯誤處理建議

---

## 📋 您只需要做什麼？

### 把您的拍照程式碼放進 3 個位置：

#### 位置 1：初始化設備（第 44-49 行）
```vb
' ===== 在此初始化您的設備（相機、PLC 等）=====
' 例如：
InitializeCamera()
InitializePLC()
ConnectToDevices()
' =================================================
```

#### 位置 2：拍攝前準備（第 117-130 行）
```vb
' ===== 步驟 2：拍攝前準備 =====
' 在此加入您的拍攝前準備工作
' 例如：
If Not PrepareCameraSettings() Then
    ShowError("相機準備失敗", "請檢查相機連線")
    ResetCaptureState()
    Return
End If
```

#### 位置 3：實際拍照邏輯（第 153-186 行）
```vb
' ╔═══════════════════════════════════════════════════════════╗
' ║  在此放入您的實際拍照程式碼                                 ║
' ╚═══════════════════════════════════════════════════════════╝

' 範例 1：單張拍照流程
Dim image As Bitmap = Camera.Capture()
Dim fileName As String = GenerateFileName(currentBatchNumber, i)
SaveImage(image, fileName)
ProcessImage(image)

' 範例 2：與 PLC 互動
PLC.TriggerCapture()
System.Threading.Thread.Sleep(100)
While Not PLC.IsCaptureReady()
    System.Threading.Thread.Sleep(10)
End While
Dim image As Bitmap = Camera.Capture()

' ╔═══════════════════════════════════════════════════════════╗
' ║  拍照程式碼結束                                             ║
' ╚═══════════════════════════════════════════════════════════╝
```

---

## 🔧 調整參數

在 `TestForm.vb` 第 7-9 行：

```vb
Private Const TOTAL_IMAGES As Integer = 350        ' 總拍照張數
Private Const UPDATE_INTERVAL As Integer = 10      ' 每幾張更新一次進度
Private Const LOG_PATH As String = "C:\Temp\CameraTestApp_Log.txt"
```

---

## 🚀 編譯和部署

### 步驟 1：編譯
1. 用 Visual Studio 2017 開啟 `CameraTestApp.sln`
2. 確認已加入您的拍照程式碼
3. 按 F6 編譯
4. 找到編譯後的檔案：`bin\Release\CameraTestApp.exe`

### 步驟 2：部署到機台
1. 複製 `CameraTestApp.exe` 到機台
2. 雙擊執行對應的 `.reg` 檔案（例如：CAM-001.reg）
3. 啟動 Python 同步程式：`啟動Python同步程式.bat`
4. 執行 `CameraTestApp.exe`

---

## 📊 程式流程

```
程式啟動
    ↓
讀取 Registry 機台設定
    ↓
初始化設備（相機、PLC 等）← 您的程式碼
    ↓
等待使用者輸入生產批號
    ↓
按「開始拍攝」
    ↓
建立任務（Registry）← 自動處理
    ↓
拍攝前準備 ← 您的程式碼
    ↓
FOR 迴圈 1 到 350
    ├─ 拍照 ← 您的程式碼
    ├─ 儲存影像 ← 您的程式碼
    ├─ 更新 UI（自動）
    └─ 更新 Registry（自動）
    ↓
拍攝完成
    ↓
顯示結果統計
```

---

## 📂 專案檔案說明

### 核心檔案
- **RegistryHelper.vb** - Registry 操作輔助類別（不需要修改）
- **TestForm.vb** - 主程式（在指定位置加入您的程式碼）
- **TestForm.Designer.vb** - Form 設計器（不需要修改）

### 專案檔案
- **CameraTestApp.sln** - 解決方案檔
- **CameraTestApp.vbproj** - 專案檔
- **App.config** - 設定檔

---

## ⚡ Registry 如何運作？

您完全不需要管 Registry 細節，程式已經自動處理：

### 程式啟動時：
```vb
RegistryHelper.SetIdle()  ' 自動設定為閒置
```

### 開始拍攝時：
```vb
RegistryHelper.CreateTask(currentBatchNumber, TOTAL_IMAGES)  ' 自動建立任務
```

### 進度更新時（每 10 張）：
```vb
RegistryHelper.UpdateProgress(i, TOTAL_IMAGES)  ' 自動更新進度
```

### 拍攝完成時：
```vb
RegistryHelper.SetIdle()  ' 自動設定回閒置
```

**就這樣！Python 背景程式會自動把 Registry 資料同步到資料庫！**

---

## 🛠️ 常見問題

### Q1: 如何加入我自己的相機控制程式碼？

A: 在第 153-186 行之間加入：
```vb
Dim image As Bitmap = YourCamera.Capture()
SaveImage(image, fileName)
```

### Q2: 如何處理拍照失敗？

A: 程式已經處理了！在第 206-221 行，有 3 種選項：
- Option 1：繼續拍攝（預設）
- Option 2：詢問使用者
- Option 3：立即中止

### Q3: 如何修改總拍照張數？

A: 修改第 7 行：
```vb
Private Const TOTAL_IMAGES As Integer = 350  ' 改成您要的數字
```

### Q4: 如何加入多相機支援？

A: 在第 173-178 行有範例：
```vb
For Each cam In CameraList
    Dim img As Bitmap = cam.Capture()
    SaveImage(img, $"{currentBatchNumber}_{i}_{cam.ID}.jpg")
Next
```

### Q5: 前端進度不更新？

A: 確認：
1. Python 同步程式正在執行
2. 查看 Log：`C:\Temp\RegistrySync_Log.txt`
3. 檢查網路連線到資料庫

---

## 📝 Log 檔案

### VB.NET Log
**位置**：`C:\Temp\CameraTestApp_Log.txt`

**內容**：
- 程式啟動/關閉
- 機台設定載入
- 拍攝開始/完成
- 進度更新
- 錯誤訊息

### Python Log
**位置**：`C:\Temp\RegistrySync_Log.txt`

**內容**：
- Registry 讀取
- 資料庫同步
- 心跳發送
- 錯誤訊息

---

## ✅ 檢查清單

部署前確認：
- [ ] 已加入您的相機初始化程式碼
- [ ] 已加入實際拍照程式碼
- [ ] 已調整 TOTAL_IMAGES 參數
- [ ] 已編譯成功（Release 模式）
- [ ] 已測試拍照流程
- [ ] 已確認進度會更新到前端

部署時：
- [ ] 複製 CameraTestApp.exe 到機台
- [ ] 匯入對應的 .reg 檔案
- [ ] 啟動 Python 同步程式
- [ ] 測試執行

---

## 🎯 總結

### 您需要做的：
1. ✅ 加入相機初始化程式碼（幾行）
2. ✅ 加入拍照程式碼（您原本的 FOR 迴圈內容）
3. ✅ 編譯
4. ✅ 完成！

### 程式已經幫您做好的：
- ✅ 機台設定讀取
- ✅ Registry 同步
- ✅ 進度追蹤
- ✅ UI 更新
- ✅ 錯誤處理
- ✅ Log 記錄
- ✅ 前端顯示

**所有複雜的資料庫同步、前端顯示，都已經自動處理好了！**
